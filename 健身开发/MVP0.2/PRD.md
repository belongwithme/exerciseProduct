好的，遵照您的要求，我基于我们之前讨论的优化点，为您生成一份优化后的产品需求文档（PRD）。

这份文档直接整合了所有建议，并以一份可供团队直接使用的、更完善的 PRD 形式呈现。

---

# 🧩 产品需求文档 (PRD) v0.2.1 (优化版)

**项目名称：** 综合训练追踪平台
**文档版本：** v0.2.1
**文档日期：** 2025-07-07
**作者：** Ian

### **文档更新日志 (Changelog)**

* **v0.2.1 (优化版):**
    * **核心架构优化:** 引入训练日志与计划版本的“不可变关联”，确保历史数据追溯的准确性。
    * **疲劳分析升级:** 算法引入用户主观反馈（训练状态、情绪），使评估更智能、更人性化。
    * **功能体验深化:** 优化了计划版本对比的实现方式，并丰富了日历视图的视觉信息。
    * **API设计优化:** 调整了部分接口以更符合 RESTful 风格。

---

## 📌 1. 引言

### 1.1 背景说明

MVP v0.1 已完成用户认证、训练计划管理、日志记录、能力评估与基础图表功能。为了更好地服务用户个性化的健身训练记录与管理需求，本阶段将聚焦于以下两个方向：

* 🌱 **功能深化：** 进一步优化现有功能的深度与体验，让应用更“懂”用户。
* 📅 **习惯养成：** 增加训练打卡与日历视图功能，提升训练的可视化与规律性追踪。

### 1.2 本轮目标

本轮开发目标为 MVP 0.2.1，力求：

* 增强训练动作与日志系统的灵活性和数据维度。
* 建立严谨的训练计划版本追溯机制。
* 上线用户友好的训练日历与打卡系统，强化视觉反馈。
* 实现更智能的疲劳评估与主动式训练建议。

---

## 🧠 2. 功能需求明细

### 2.1 功能优化模块（v0.1已有功能增强）

#### ✅ 2.1.1 训练动作库扩展与定制

**目标：** 增强动作信息结构，提升筛选与自定义能力。
**功能点：**

* **数据结构扩展:**
    * 增加动作的「类型」字段 (例如：力量, 柔韧性, 有氧)。
    * 增加「动作难度等级」字段 (例如：初级, 中级, 高级)。
* **前端交互优化:**
    * 支持用户按肌群、器械、难度、类型进行多维度组合筛选。
* **未来规划:**
    * 为后续“用户自定义动作”功能预留入口。

#### ✅ 2.1.2 训练日志高级功能

**目标：** 提高训练记录效率与数据丰富度。
**功能点：**

* **便捷操作:**
    * 支持“一键复制上次训练”功能，将指定历史日志的动作和组数作为新日志的模板。
    * UI支持拖拽调整已记录组的顺序。
* **主观反馈记录:**
    * 新增「训练状态」标签字段，用户可选择“状态良好 / 疲劳 / 低效率”等。
    * 训练感想笔记支持添加 Emoji 标签，作为 `mood` 字段记录，用于情绪分析。

#### ✅ 2.1.3 训练计划版本管理

**目标：** 精准跟踪用户对训练计划的修改历史，并提供追溯能力。
**功能点：**

* **版本快照:**
    * 用户每次保存对训练计划的编辑时，系统自动在 `workout_plan_versions` 表中生成一个带有时间戳的版本快照。快照内容以 JSONB 格式存储。
* **历史版本管理:**
    * UI界面提供入口，可查看当前计划的「历史版本列表」。
    * 支持用户选择任一历史版本进行“一键恢复”。
* **版本对比 (MVP实现):**
    * **优化方案:** 实现 **“并排高亮对比”**。当用户选择对比两个版本时，前端以并排或上下卡片的形式展示两个版本的 `content` 内容，并将有差异的动作、组数、次数、备注等用不同的背景色高亮显示。此方案可满足核心需求且开发成本可控。

#### ✅ 2.1.4 疲劳趋势分析与休息建议 (智能算法升级)

**目标：** 结合客观数据与主观感受，提供更精准的疲劳评估和主动休息建议。
**功能点：**

* **智能疲劳指数算法:**
    * **算法构成:** `疲劳指数 = f(客观训练负荷 * 权重A + 主观状态评分 * 权重B)`
    * **客观训练负荷:** 综合计算过去7天的训练频率、总容量（总重量 * 总次数）、平均训练时长等数据。
    * **主观状态评分:** 将用户在 `workout_logs` 中记录的 `status` 标签（如“疲劳”=-1分，“状态良好”=+1分）和 `mood` 转化为数值，进行加权计算。
* **主动建议与提醒:**
    * 在用户主页或仪表盘显著位置，展示计算出的“疲劳指数”（如0-100分）及趋势变化图。
    * 若指数超出安全阈值（如 >80），系统自动弹出提示：“您最近的训练负荷较高，且身体反馈偏向疲劳，建议安排休息日或进行低强度恢复性训练。”。

---

### 2.2 新增功能模块（v0.2.1重点）

#### 🆕 2.2.1 打卡系统 + 增强型日历视图

**目标：** 通过强化的视觉反馈和数据追溯，帮助用户建立训练习惯。
**功能点：**

* **自动打卡:**
    * 用户每次成功提交一份 `workout_logs` 即视为完成一次“打卡”。
* **增强型日历视图:**
    * **热力图 + 状态标记:** 在月度日历视图中，使用颜色深浅（热力图）标记当日的训练容量或时长。同时，在格子内增加一个 **彩色圆点或图标** 来直观展示当天的主要「训练状态」 (`status`)。
        * 例如：🟢代表“状态良好”，🟡代表“疲劳”。
    * **信息摘要:** 点击日历中的某一天，可快速预览当日的训练摘要，如：完成的动作数量、主要训练类型、时长、以及完整的状态和心情标签。
* **习惯激励:**
    * 在UI上统计并展示用户的“连续打卡天数”（Streak）。
    * 当连续打卡中断时，给予友好提示和鼓励。

---

## 🧩 3. 数据模型（ERD补充建议）

为支持以上功能，数据模型需进行以下关键更新。

| 表名 | 字段名 | 类型 | 说明 |
| --- | --- | --- | --- |
| `exercises` | `difficulty_level` | text | 动作难度等级（初级/中级/高级），建议使用ENUM或应用层校验。 |
| `exercises` | `type` | text | 动作类型（力量/柔韧性/有氧等），建议使用ENUM或应用层校验。 |
| `workout_logs` | `status` | text | 训练状态标签（状态良好/疲劳/低效率），用于疲劳度分析。 |
| `workout_logs` | `mood` | text | 训练感受或emoji，用于打卡感想和情绪分析。 |
| `workout_logs` | **`plan_version_id`** | **bigint (FK)** | **【核心优化】** 外键，关联到`workout_plan_versions.id`。用于将该条日志与一个**不可变**的计划版本快照锁定，确保历史追溯的绝对准确性。 |
| `workout_plans` | `version` | integer | 指向当前最新版本的版本号。 |
| `workout_plan_versions` | (新增表) | - | 存储计划的每一个历史版本快照。 |

---

## 🚀 4. API 接口草案（新增/优化部分）

| Method | Endpoint | 功能说明 |
| --- | --- | --- |
| GET | `/api/calendar-summary` | 获取用户日历视图所需的聚合数据（建议由`training_calendar_summary`视图支持）。 |
| **POST** | **`/api/plans/:plan_id/versions`** | **【优化】** 为指定的训练计划创建一个新的版本快照，更符合RESTful风格。 |
| GET | `/api/plans/:plan_id/versions` | 获取指定计划的所有历史版本列表信息。 |
| GET | `/api/plans/:plan_id/versions/:version_number` | 获取指定计划某个具体版本号的详细内容（JSONB）。 |
| GET | `/api/fatigue-index` | 获取当前用户的疲劳指数评分、趋势以及系统给出的训练建议。 |

---

## 🧪 5. 非功能需求补充

* **性能要求:** 日历视图必须实现快速加载。后端使用 SQL 视图 `training_calendar_summary` 预聚合数据是高效的方式，应优先实现。
* **用户体验设计:**
    * 所有新增的视觉反馈元素（日历状态圆点、版本对比高亮、疲劳指数仪表盘）必须清晰易懂，并提供优雅的动画效果。
    * **强化正反馈:** 连续打卡天数增加、打破个人记录、疲劳度从高降低等时刻，应有即时的、激励性的UI反馈。
* **响应式设计:** 所有新界面，特别是日历和卡片式布局，必须在移动端和桌面端都有良好的适配和交互体验。