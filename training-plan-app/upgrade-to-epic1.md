# 🚀 Epic 1 数据库升级快速指南

本指南将帮助您将现有的训练计划应用数据库升级到 MVP 0.2.1，支持所有 Epic 1 的新功能。

## ⚠️ 升级前准备

### 1. 数据备份（必须）
在执行升级前，请务必备份您的数据：

1. 登录 [Supabase 控制台](https://supabase.com)
2. 选择您的项目
3. 进入 Settings > Database
4. 创建数据库备份或导出重要数据

### 2. 检查当前版本
确认您的数据库是基于项目的初始 `schema.sql` 创建的。

## 🛠️ 执行升级

### 方法一：通过 Supabase Web 界面（推荐）

1. **打开 SQL 编辑器**
   - 在 Supabase 控制台中，点击左侧菜单的 "SQL Editor"
   - 点击 "New Query" 创建新查询

2. **执行升级脚本**
   - 复制 `src/lib/database/epic1-upgrade.sql` 文件的全部内容
   - 粘贴到 SQL 编辑器中
   - 点击 "Run" 按钮执行
   - 等待执行完成（通常需要 1-2 分钟）

3. **验证升级结果**
   - 检查控制台输出，应显示成功消息
   - 在 "Table Editor" 中验证新表和字段是否已创建

## ✅ 升级验证清单

升级完成后，请验证以下内容：

### 新增表
- [ ] `workout_plan_versions` - 训练计划版本表已创建
- [ ] `training_calendar_summary` - 日历聚合视图已创建

### 更新的表字段
- [ ] `exercises` 表：
  - [ ] 新增 `type` 字段（动作类型）
  - [ ] `difficulty_level` 字段改为 TEXT 类型（初级/中级/高级）
- [ ] `workout_logs` 表：
  - [ ] 新增 `status` 字段（训练状态）
  - [ ] 新增 `mood` 字段（情绪记录）
  - [ ] 新增 `plan_version_id` 字段（关联计划版本）
- [ ] `workout_plans` 表：
  - [ ] 新增 `version` 字段（版本号）

### 数据迁移验证
- [ ] 现有训练计划是否已创建初始版本（version 1）
- [ ] 现有动作的 `difficulty_level` 是否已正确转换为文本

### 权限和安全
- [ ] 新表的 RLS 策略是否已启用
- [ ] 用户是否只能访问自己的数据

## 🎯 升级后的新功能

升级完成后，您的数据库将支持以下新功能：

1. **增强的动作库**
   - 动作类型分类（力量/有氧/柔韧性等）
   - 更直观的难度等级显示

2. **丰富的训练日志**
   - 训练状态记录（状态良好/疲劳/低效率）
   - 情绪和感受记录

3. **计划版本管理**
   - 自动保存计划修改历史
   - 支持版本对比和恢复

4. **高效的日历视图**
   - 预聚合的训练数据
   - 优化的查询性能

5. **性能优化**
   - 新增多个复合索引
   - 优化高频查询性能

## 🔧 故障排除

### 常见问题

**问题：权限不足错误**
- 解决：确保您是项目的所有者或管理员

**问题：表已存在错误**
- 解决：升级脚本使用了安全检查，如果遇到此问题，可能是之前已执行过升级

**问题：数据类型转换失败**
- 解决：检查现有 `exercises` 表的 `difficulty_level` 字段是否包含有效数据

**问题：外键约束错误**
- 解决：确保您的数据库结构与标准 `schema.sql` 一致

### 获取帮助

如果遇到问题，请：
1. 检查 Supabase 控制台的错误日志
2. 确认数据库备份已创建
3. 查看详细的执行日志

## 📚 相关文档

- [完整数据库文档](src/lib/database/README.md)
- [Epic 1 升级脚本](src/lib/database/epic1-upgrade.sql)
- [产品需求文档](健身开发/MVP0.2/PRD.md)
- [数据库设计文档](健身开发/MVP0.2/ERD.md)

---

*升级完成后，您的训练计划应用将支持所有 MVP 0.2.1 的新功能！* 