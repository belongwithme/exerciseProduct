import{am as l,an as d}from"./OdQOizuy.js";import{s as n}from"./x2EdFAPA.js";const f={user:null,session:null,loading:!0,error:null},t=d(f),m=l(t,r=>r.user);l(t,r=>r.session);const y=l(t,r=>r.loading),w=l(t,r=>r.error),c=d(null);async function g(){try{const{data:{session:r},error:s}=await n.auth.getSession();if(s){console.error("获取会话错误:",s),t.update(a=>({...a,error:s.message,loading:!1}));return}t.update(a=>({...a,user:(r==null?void 0:r.user)||null,session:r,loading:!1,error:null})),r!=null&&r.user&&await i(r.user.id),n.auth.onAuthStateChange(async(a,e)=>{var o;console.log("认证状态变化:",a,(o=e==null?void 0:e.user)==null?void 0:o.email),t.update(u=>({...u,user:(e==null?void 0:e.user)||null,session:e,loading:!1,error:null})),a==="SIGNED_IN"&&(e!=null&&e.user)?await i(e.user.id):a==="SIGNED_OUT"&&c.set(null)})}catch(r){console.error("初始化认证错误:",r),t.update(s=>({...s,error:"认证初始化失败",loading:!1}))}}async function i(r){try{const{data:s,error:a}=await n.from("profiles").select("*").eq("id",r).single();if(a&&a.code!=="PGRST116"){console.error("加载用户配置文件错误:",a);return}s&&c.set(s)}catch(s){console.error("加载用户配置文件异常:",s)}}async function E(r,s,a){t.update(e=>({...e,loading:!0,error:null}));try{const{data:e,error:o}=await n.auth.signUp({email:r,password:s,options:{data:{full_name:a}}});return o?(t.update(u=>({...u,error:o.message,loading:!1})),{success:!1,error:o.message}):(t.update(u=>({...u,loading:!1})),{success:!0,data:e})}catch(e){const o=e instanceof Error?e.message:"注册失败";return t.update(u=>({...u,error:o,loading:!1})),{success:!1,error:o}}}async function S(r,s){t.update(a=>({...a,loading:!0,error:null}));try{const{data:a,error:e}=await n.auth.signInWithPassword({email:r,password:s});return e?(t.update(o=>({...o,error:e.message,loading:!1})),{success:!1,error:e.message}):(t.update(o=>({...o,user:a.user,session:a.session,loading:!1})),{success:!0,data:a})}catch(a){const e=a instanceof Error?a.message:"登录失败";return t.update(o=>({...o,error:e,loading:!1})),{success:!1,error:e}}}async function I(){t.update(r=>({...r,loading:!0,error:null}));try{const{error:r}=await n.auth.signOut();return r?(t.update(s=>({...s,error:r.message,loading:!1})),{success:!1,error:r.message}):(t.update(s=>({...s,user:null,session:null,loading:!1})),c.set(null),{success:!0})}catch(r){const s=r instanceof Error?r.message:"登出失败";return t.update(a=>({...a,error:s,loading:!1})),{success:!1,error:s}}}function P(){t.update(r=>({...r,error:null}))}typeof window<"u"&&g();export{w as a,y as b,P as c,E as d,I as e,c as f,g as i,S as s,m as u};
