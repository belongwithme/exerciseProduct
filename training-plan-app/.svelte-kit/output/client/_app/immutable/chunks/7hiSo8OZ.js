import{al as l,am as d}from"./CDvu5KIv.js";import{s as u}from"./x2EdFAPA.js";const f={user:null,session:null,loading:!0,error:null},t=d(f),m=l(t,r=>r.user);l(t,r=>r.session);const w=l(t,r=>r.loading),y=l(t,r=>r.error),c=d(null);async function g(){try{const{data:{session:r},error:s}=await u.auth.getSession();if(s){console.error("获取会话错误:",s),t.update(e=>({...e,error:s.message,loading:!1}));return}t.update(e=>({...e,user:(r==null?void 0:r.user)||null,session:r,loading:!1,error:null})),r!=null&&r.user&&await i(r.user.id),u.auth.onAuthStateChange(async(e,a)=>{var o;console.log("认证状态变化:",e,(o=a==null?void 0:a.user)==null?void 0:o.email),t.update(n=>({...n,user:(a==null?void 0:a.user)||null,session:a,loading:!1,error:null})),e==="SIGNED_IN"&&(a!=null&&a.user)?await i(a.user.id):e==="SIGNED_OUT"&&c.set(null)})}catch(r){console.error("初始化认证错误:",r),t.update(s=>({...s,error:"认证初始化失败",loading:!1}))}}async function i(r){try{const{data:s,error:e}=await u.from("profiles").select("*").eq("id",r).single();if(e&&e.code!=="PGRST116"){console.error("加载用户配置文件错误:",e);return}s&&c.set(s)}catch(s){console.error("加载用户配置文件异常:",s)}}async function E(r,s,e){t.update(a=>({...a,loading:!0,error:null}));try{const{data:a,error:o}=await u.auth.signUp({email:r,password:s,options:{data:{full_name:e}}});return o?(t.update(n=>({...n,error:o.message,loading:!1})),{success:!1,error:o.message}):(t.update(n=>({...n,loading:!1})),{success:!0,data:a})}catch(a){const o=a instanceof Error?a.message:"注册失败";return t.update(n=>({...n,error:o,loading:!1})),{success:!1,error:o}}}async function S(r,s){t.update(e=>({...e,loading:!0,error:null}));try{const{data:e,error:a}=await u.auth.signInWithPassword({email:r,password:s});return a?(t.update(o=>({...o,error:a.message,loading:!1})),{success:!1,error:a.message}):(t.update(o=>({...o,user:e.user,session:e.session,loading:!1})),{success:!0,data:e})}catch(e){const a=e instanceof Error?e.message:"登录失败";return t.update(o=>({...o,error:a,loading:!1})),{success:!1,error:a}}}async function I(){t.update(r=>({...r,loading:!0,error:null}));try{const{error:r}=await u.auth.signOut();return r?(t.update(s=>({...s,error:r.message,loading:!1})),{success:!1,error:r.message}):(t.update(s=>({...s,user:null,session:null,loading:!1})),c.set(null),{success:!0})}catch(r){const s=r instanceof Error?r.message:"登出失败";return t.update(e=>({...e,error:s,loading:!1})),{success:!1,error:s}}}async function M(r){try{const{data:{user:s}}=await u.auth.getUser();if(!s)throw new Error("用户未登录");const{data:e,error:a}=await u.from("profiles").update(r).eq("id",s.id).select().single();if(a)throw a;return c.set(e),{success:!0,data:e}}catch(s){return{success:!1,error:s instanceof Error?s.message:"更新配置文件失败"}}}function P(){t.update(r=>({...r,error:null}))}typeof window<"u"&&g();export{y as a,w as b,P as c,E as d,c as e,I as f,M as g,g as i,S as s,m as u};
